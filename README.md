# Express Boilerplate!

This is a boilerplate used for starting new RESTful projects!

## Set up

Complete the following steps to start a new project (NEW-PROJECT-NAME):

1. Clone this repository to your local machine `git clone BOILERPLATE-URL NEW-PROJECTS-NAME`
2. `cd` into the cloned repository
3. Make a fresh start of the git history for this project with `rm -rf .git && git init`
4. Install the node dependencies `npm i`
5. Move the example Environment file to `.env` that will be ignored by git and read by the express server `mv example.env .env`
6. Edit the contents of the `package.json` to use NEW-PROJECT-NAME instead of `"name": "express-boilerplate",`

## Scripts

Start the application `npm start`

Start nodemon for the application `npm run dev`

Run the tests `npm test`

## Blogful API post-article branch

https://github.com/Thinkful-Ed/blogful-api/tree/post-article/migrations

## Deploying

When your new project is ready for deployment, add a new Heroku application with `heroku create`. This will make a new git remote called "heroku" and you can then `npm run deploy` which will push to this remote's main branch.

## Flow of the application

1.) We start the server with npm start aka node ./src/server.js
2.) The server.js file requires the app instance from the app.js file
3.) The app.js file creates the express instance, app and exports it
4.) The server.js file creates the Knex instance
5.) The server.js file attaches the Knex instance to the app as a property called 'db'
6.) The server.js tells the app to start listening on a port number
7.) Any request handling middleware can now read the 'db' property on the app to get the Knex instance

## Steps for Building an Express Database that retreives data

1.) Make a new express project called blogful-api.

git clone https://github.com/[YOUR-USERNAME]/express-boilerplate.git blogful-api
cd $_
rm -rf .git && git init
mv example.env .env
npm install
git add -A && git commit -m 'first commit'

2.) Create a new database called blogful.

createdb -U dunder_mifflin blogful
(verify using npm t and npm run dev)

3.) Make migrations to manage the creation of tables and relations.

-1st migration:
Create a new type article_category and call the new column on the table style.

CREATE TYPE article_category AS ENUM (
    'Listicle',
    'How-to',
    'News',
    'Interview',
    'Story'
);

ALTER TABLE blogful_articles
  ADD COLUMN
    style article_category;

-Install Postgrator as a devDependency:

npm i postgrator-cli@3.2.0 -D
(connects to DB by reading config file containing DB_URL)

-Make config.js

require('dotenv').config();

module.exports = {
  "migrationsDirectory": "migrations",
  "driver": "pg",
  "connectionString": process.env.DB_URL,
}

-Add to .env file:

+ DB_URL="postgresql://dunder_mifflin@localhost/blogful"

-run npm i pg
(installs driver setting for knexInstance and our migrationsDirectory)

-Make the "do" migration file and put it in the migrationsDirectory we specified: ./migrations/001.do.create_blogful_articles.sql.

CREATE TABLE blogful_articles (
    id INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    title TEXT NOT NULL,
    content TEXT,
    date_published TIMESTAMPTZ DEFAULT now() NOT NULL
);
And make the "undo" migration: ./migrations/001.undo.create_blogful_articles.sql:

DROP TABLE IF EXISTS blogful_articles;

-Edit package.json to include postgrator-cli

+  "migrate": "postgrator --config postgrator-config.js",

-run first migration 
"do" npm run migrate -- 1
"undo" npm run migrate --0
"default --> max" npm run migrate

-2nd migration:
  "do" ./migrations/002.do alter_article_style.sql:

CREATE TYPE article_category AS ENUM (
    'Listicle',
    'How-to',
    'News',
    'Interview',
    'Story'
);

ALTER TABLE blogful_articles
  ADD COLUMN
    style article_category;

  "undo": ./migrations/002.undo.alter_article_style.sql

ALTER TABLE blogful_articles DROP COLUMN IF EXISTS style;

DROP TYPE IF EXISTS article_category;

(npm run migrate --version to verify; leave on latest version) 

4.) Make seeding scripts to populate the tables with dummy data.

-Make the file: ./seeds/seed.blogful_articles.sql

INSERT INTO blogful_articles (title, style, content)
VALUES
  ('First post!', 'Interview',
    'Lorem ipsum dolor sit amet, consectetur adipisicing elit. Natus consequuntur deserunt commodi, nobis qui inventore corrupti iusto aliquid debitis unde non. Adipisci, pariatur. Molestiae, libero esse hic adipisci autem neque?'),
  ('Second post!', 'How-to',
    'Lorem ipsum dolor sit amet consectetur adipisicing elit. Cum, exercitationem cupiditate dignissimos est perspiciatis, nobis commodi alias saepe atque facilis labore sequi deleniti. Sint, adipisci facere! Velit temporibus debitis rerum.'); //etc

-Seed the database:

psql -U dunder_mifflin -d blogful -f ./seeds/seed.blogful_articles.sql

-Install knex
npm i knex

-Create knexInstance in controller (./src/server.js)

const knex = require('knex')
const { PORT, DB_URL } = require('./config')

const db = knex({
  client: 'pg',
  connection: 'process.env.DB_URL || 'postgresql://dunder_mifflin@localhost/blogful'
})

-Make GET/articles endpoint:

app.use(helmet)
app.get('/articles', (req, res, next) => {
  res.send('ArticlesService.getAllArticles(knexInstance)
      .then(articles => {
      res.json(articles)
     })
     .catch(next)')
})

-Require articles.service.js in ./src/app.js

const ArticlesService = require('./articles-service')

  const app = express()


-Set 'db' property in app nstance inside ./src/server.js:

  const db = knex({
    client: 'pg',
    connection: DB_URL,
  })

+ app.set('db', db)


5.) Copy the ArticlesService file into the new project.
6.) Write the first endpoint for GET /articles using the ArticlesService.
7.) Write express integration tests for GET /articles using both supertest and knex.
8.) Write the other endpoints and tests for POST /articles and DELETE /articles/:article_id.
